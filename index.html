<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCAT VR Practice - MedwithPurpose</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Custom styles for better UI/UX */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrolling on body */
            font-family: 'Inter', sans-serif;
        }

        /* --- REDESIGNED THEMES --- */
        .theme-background {
            background-color: #f0f2f5;
        }

        #setup-screen, #results-screen {
            background: linear-gradient(170deg, #c7d2fe 0%, #f0f2f5 50%, #b0bec5 100%);
        }

        .card {
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            border-radius: 1rem;
        }

        .primary-button-new {
            background-image: linear-gradient(135deg, #4f46e5, #6366f1);
            color: white;
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
        }
        .primary-button-new:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
            background-image: linear-gradient(135deg, #4338ca, #4f46e5);
        }

        .secondary-button-new {
            background-color: transparent;
            color: #4353ff;
            border: 1px solid #4353ff;
            transition: all 0.3s ease;
             font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
        }
        .secondary-button-new:hover {
            background-color: rgba(67, 83, 255, 0.1);
            transform: translateY(-2px);
        }

        input.themed-input {
            background-color: #f0f2f5;
            border: 1px solid #d1d5db;
            color: #1f2937;
        }
        input.themed-input:focus {
            border-color: #4353ff;
            box-shadow: 0 0 0 2px rgba(67, 83, 255, 0.2);
            outline: none;
        }

        /* --- Original Test Environment Styles --- */
        #app-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 2rem);
            width: 100%;
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 0.375rem;
            margin: 1rem;
            overflow: hidden;
        }
        .header-bar, .footer-bar {
            flex-shrink: 0;
            background-color: #006DAA;
            color: white;
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-bar span, .header-bar div { color: white; }
        #timer { background-color: rgba(255, 255, 255, 0.2); color: white; font-weight: bold; padding: 0.25rem 0.75rem; border-radius: 0.25rem; }
        .footer-bar button, .font-size-button { background-color: transparent; color: white; border: 1px solid rgba(255, 255, 255, 0.5); padding: 0.4rem 0.8rem; font-size: 0.8rem; border-radius: 0.375rem; transition: background-color 0.2s ease, border-color 0.2s ease; }
        .font-size-button { padding: 0.2rem 0.6rem; font-weight: bold; line-height: 1.25; }
        .footer-bar button:hover:not(:disabled), .font-size-button:hover:not(:disabled) { background-color: rgba(255, 255, 255, 0.15); border-color: white; }
        .footer-bar button:disabled { opacity: 0.5; cursor: not-allowed; border-color: rgba(255, 255, 255, 0.3); }
        .footer-bar button#next-button { background-color: #ffffff; color: #006DAA; border: 1px solid white; font-weight: 500; }
        .footer-bar button#next-button:hover:not(:disabled) { background-color: #f0f0f0; }
        #flag-button { background-color: transparent; border: 1px solid white; color: white; transition: background-color 0.2s ease, color 0.2s ease; }
        #flag-button:hover { background-color: white; color: #006DAA; }
        #flag-button.flagged { background-color: #facc15; border-color: #facc15; color: #422006; }
        #flag-button.flagged:hover { background-color: #f59e0b; border-color: #f59e0b; }

        .main-content-area { flex-grow: 1; display: flex; overflow: hidden; padding: 1rem; gap: 1rem; }
        
        /* UPDATED: Column widths changed to 60/40 split */
        .passage-column {
            flex: 0 0 60%;
            overflow-y: auto; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; background-color: #ffffff; height: 100%; transition: font-size 0.2s ease;
        }
        .question-column {
            flex: 0 0 40%;
            overflow-y: auto; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; background-color: #ffffff; height: 100%; transition: font-size 0.2s ease;
            position: relative;
        }

        .selected-answer { background-color: #bfdbfe !important; border-color: #3b82f6 !important; }
        .nav-answered { background-color: #a7f3d0; }
        .nav-current { border: 2px solid #3b82f6 !important; font-weight: bold; }
        .nav-flagged, .review-flagged { border: 2px solid #f59e0b !important; position: relative; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 0.5rem; }
        .modal.flex { display: flex; }

        .option-label { display: block; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.5rem; cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease; background-color: #ffffff; color: #111827; }
        .option-label:hover:not(.selected-answer) { background-color: #f3f4f6; border-color: #a5b4fc; }
        input[type="radio"] { display: none; }
        .resizable-text { font-size: 1rem; }

        .explanation-box { background-color: #f3f4f6; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; margin-top: 0.75rem; border-radius: 0.375rem; color: #111827; }

        .review-grid-button { padding: 0.5rem 0.25rem; border: 1px solid #d1d5db; border-radius: 0.375rem; text-align: center; transition: background-color 0.2s ease, border-color 0.2s ease; font-size: 0.875rem; line-height: 1.25rem; cursor: pointer; }
        .review-grid-button-answered { background-color: #dcfce7; border-color: #86efac; color: #15803d; }
        .review-grid-button-unanswered { background-color: #f3f4f6; border-color: #d1d5db; color: #4b5563; }
        .review-grid-button:hover { filter: brightness(95%); }

        /* Results Screen Grid */
        #results-grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 0.75rem; padding: 1rem 0; width: 100%; }
        .result-box { display: flex; flex-direction: column; align-items: center; justify-content: center; aspect-ratio: 1 / 1; padding: 0.25rem; border-radius: 0.5rem; color: white; text-align: center; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1); width: 100%; height: auto; border: none; }
        .result-box:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        
        .result-box-correct {
            background: linear-gradient(145deg, #22c55e, #15803d);
        }
        .result-box-incorrect {
            background: linear-gradient(145deg, #ef4444, #b91c1c);
        }
        .result-box-flagged { outline: 3px solid #f59e0b; outline-offset: 2px; }
        .result-box .time-spent { font-size: 1rem; font-weight: 600; line-height: 1.1; }
        .question-num-label { font-size: 0.75rem; color: #4b5563; text-align: center; width: 100%; margin-top: 0.25rem; }

        @media (max-width: 768px) {
            #app-container { height: auto; margin: 0.5rem; }
            .main-content-area { flex-direction: column; padding: 0.5rem; gap: 0.5rem; }
            .passage-column, .question-column { flex-basis: auto; width: 100%; } /* Reverts to block-level stacking on mobile */
            .header-bar, .footer-bar { padding: 0.5rem 1rem; }
            .header-bar span, .footer-bar button, .font-size-button { font-size: 0.8rem; }
            #review-grid { grid-template-columns: repeat(5, minmax(0, 1fr)); }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    </head>
<body class="theme-background">

    <div id="app-container" class="!border-none !shadow-none !m-0 !rounded-none">

        <div id="setup-screen" class="p-4 md:p-8 flex flex-col justify-center items-center h-full w-full">
            <div class="w-full max-w-lg text-center">
                <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141"
                     alt="MedwithPurpose Logo"
                     class="mx-auto h-24 w-auto mb-6"
                     onerror="this.style.display='none'; this.onerror=null;">
                <div class="card p-8 md:p-10">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">Verbal Reasoning Practice</h1>
                    <p class="text-gray-600 mt-2 text-lg mb-8">Sharpen your skills for the UCAT VR section.</p>
                    <div class="text-left space-y-3 mb-8 bg-blue-50/50 border border-blue-200/50 rounded-lg p-4">
                        <p class="text-sm text-gray-800"><strong class="font-semibold">Questions:</strong> <span id="setup-question-count">16</span></p>
                        <p class="text-sm text-gray-800"><strong class="font-semibold">Time Limit:</strong> <span id="setup-time-limit">9 minutes</span></p>
                    </div>

                    <div class="space-y-6 text-left">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                            <input type="text" id="name" name="name" class="themed-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Enter your name">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="goal" class="block text-sm font-medium text-gray-700 mb-1">Score Goal</label>
                                <input type="number" id="goal" name="goal" min="0" max="16" class="themed-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none sm:text-sm" placeholder="e.g., 12">
                            </div>
                            <div>
                                <label for="focus-area" class="block text-sm font-medium text-gray-700 mb-1">Practice Intention</label>
                                <input type="text" id="focus-area" name="focus-area" class="themed-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none sm:text-sm" placeholder="e.g., Speed, Accuracy">
                            </div>
                        </div>
                    </div>

                    <div class="mt-10">
                        <button id="start-button" class="primary-button-new w-full text-lg">
                            Start Exam
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <div id="exam-screen" class="hidden flex flex-col h-full">
            <div class="header-bar">
                <span id="exam-title" class="font-semibold">Verbal Reasoning</span>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <button id="font-decrease-button" class="font-size-button">A-</button>
                        <button id="font-increase-button" class="font-size-button">A+</button>
                    </div>
                    <div id="timer" class="text-base px-3 py-1 rounded-md">9:00</div>
                    <span class="text-sm">Question <span id="question-number-info">1</span> of 16</span>
                    <button id="flag-button" class="text-sm font-medium border border-white rounded px-2 py-1 transition-colors duration-150">
                         Flag for Review
                    </button>
                </div>
            </div>
            <div class="main-content-area">
                <div class="passage-column resizable-text">
                    <h3 class="text-lg font-semibold mb-2 sticky top-0 bg-white text-gray-900 pb-1">Passage <span id="passage-number">1</span></h3>
                    <div id="passage-text" class="text-base text-gray-900 leading-relaxed whitespace-pre-wrap"></div>
                </div>
                <div class="question-column resizable-text">
                     <h4 class="text-md font-semibold mb-3 sticky top-0 bg-white text-gray-900 pb-1">Question <span id="question-number">1</span></h4>
                    <p id="question-text" class="mb-4 text-gray-900"></p>
                    <div id="options-container" class="space-y-2"></div>
                    <div id="review-explanation-container"></div>
                </div>
            </div>
            <div class="footer-bar">
                <button id="back-to-results-button" class="hidden mr-auto">← Back to Results</button>
                <button id="end-exam-button-footer">End Exam</button>
                <div class="flex items-center space-x-2 ml-auto">
                    <button id="prev-button" disabled>← Previous (Alt+P)</button>
                    <button id="navigator-button">Navigator</button>
                    <button id="next-button">Next (Alt+N) →</button>
                </div>
            </div>
        </div>

        <div id="review-screen" class="hidden p-6 md:p-8 flex-col items-center h-full overflow-y-auto bg-gray-50">
             <div class="w-full max-w-3xl mb-4 flex justify-between items-center">
                 <h2 class="text-2xl font-bold text-gray-900">Review Your Answers</h2> <button id="filter-flagged-button" class="bg-white border border-gray-300 text-gray-700 px-3 py-1 rounded-md text-sm hover:bg-gray-100">Show Flagged Only</button>
            </div>
             <p class="text-center text-gray-600 mb-6">Click on a question number to review it. Green indicates answered, Yellow border indicates flagged.</p>
             <div id="review-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-10 gap-3 mb-6 w-full max-w-3xl"></div>
            <div class="mt-auto pt-6">
                <button id="end-exam-button" class="bg-red-600 text-white hover:bg-red-700 text-lg px-8 py-3 rounded-md">
                    End Exam & See Results
                </button>
            </div>
        </div>


        <div id="results-screen" class="hidden p-4 md:p-8 flex-col h-full overflow-y-auto w-full">
            <div class="w-full max-w-4xl mx-auto">
                <div class="text-center mb-8">
                    <h2 class="text-3xl md:text-4xl font-bold text-gray-900">Exam Results</h2>
                    <p class="text-gray-600 mt-2">Here's a breakdown of your performance.</p>
                </div>

                <div class="card p-8 mb-8 text-center">
                    <p class="text-lg text-gray-600 mb-2">Your Score</p>
                    <p class="text-6xl font-bold text-gray-900"><span id="score">0</span><span class="text-4xl text-gray-500"> / <span id="total-questions-results">16</span></span></p>
                    <div class="mt-4 h-1 w-24 bg-indigo-200 mx-auto rounded-full"></div>
                    <p class="mt-4 text-md text-gray-500">Time Taken: <span id="time-taken" class="font-semibold"></span></p>
                </div>

                <div class="grid md:grid-cols-5 gap-8 mb-8">
                    <div class="md:col-span-2 space-y-8">
                        <div class="card p-6">
                            <h4 class="text-lg font-semibold mb-3 text-center text-gray-800">Time Analysis</h4>
                            <div id="time-analysis-results" class="space-y-2 text-sm text-gray-600"></div>
                        </div>
                        <div class="card p-6">
                            <h4 class="text-lg font-semibold mb-3 text-center text-gray-800">Performance by Type</h4>
                            <div id="type-analysis-results" class="space-y-2 text-sm text-gray-600"></div>
                        </div>
                    </div>
                    <div class="md:col-span-3 card p-6">
                         <h3 class="text-lg font-semibold mb-1 text-gray-800">Detailed Results</h3>
                         <p class="text-sm text-gray-500 mb-4">Click a box to review the question.</p>
                         <div id="results-grid-container"></div>
                    </div>
                </div>

                <div class="card p-8 mb-8">
                    <h3 class="text-xl font-semibold mb-6 text-gray-800">Reflection</h3>
                    <div class="space-y-6">
                        <div>
                            <label for="reflection-q1" class="block text-md font-semibold text-gray-700 mb-2">Which question type was most challenging, and why?</label>
                            <textarea id="reflection-q1" rows="3" class="themed-input block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="e.g., Inference questions were tricky because..."></textarea>
                        </div>
                        <div>
                            <label for="reflection-q2" class="block text-md font-semibold text-gray-700 mb-2">Which question took you the longest, and why?</label>
                            <textarea id="reflection-q2" rows="3" class="themed-input block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="e.g., Question 7 took a while because I had to re-read the passage..."></textarea>
                        </div>
                        <div>
                            <label for="reflection-q3" class="block text-md font-semibold text-gray-700 mb-2">Did you stick to your 'Practice Intention'? If not, what distracted you?</label>
                            <textarea id="reflection-q3" rows="3" class="themed-input block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="I wanted to focus on speed, but got bogged down in the details..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="text-center flex justify-center items-center space-x-4">
                    <button onclick="window.location.reload()" class="secondary-button-new">
                        Try Again
                    </button>
                    <button id="download-pdf-button" class="primary-button-new">
                        Download Results PDF
                    </button>
                </div>
            </div>
        </div>


        <div id="navigator-modal" class="modal">
            <div class="modal-content bg-white p-6 rounded-lg shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-900">Question Navigator</h3> <button id="close-modal-button" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                </div>
                 <p class="text-sm text-gray-600 mb-4">Click a number to jump. Green: answered, Yellow border: flagged.</p>
                 <div id="navigator-grid" class="grid grid-cols-5 gap-3"></div>
            </div>
        </div>

    </div>

    <script>
        // --- Data & State ---
        const passages = [
            `Long before wrist-watches were synchronised to a radio signal, noon was whenever the Sun stood highest above a given town. By the 1840s, however, British railway engines were outrunning that ancient habit: a passenger who left Exeter at "local" 12:05 p.m. and arrived in Bristol at "local" 12:00 p.m. could appear to have travelled backwards in time. To prevent missed connections (and lawsuits), the Great Western Railway quietly adopted the single meridian of Greenwich in 1847, obliging every station clock along its 300-mile network to be reset by telegraph. Other companies followed, and by 1855 "railway time" governed 98 percent of public timetables in Britain-yet many church towers still rang their own, stubborn minutes late.\nAcross the Atlantic the difficulty was magnified: at "sun time" the United States possessed roughly 300 distinct local meridians. After a near-collision outside New Jersey in 1881, railway managers met in secret and drafted a four-zone map that ignored state borders but aligned neatly with major trunk lines. On 18 November 1883-nicknamed "The Day of Two Noons"-telegraphers sent a rolling wave of clicks from east to west; as the signal passed each depot the station-master halted the clock until the prescribed minute caught up.\nInternational endorsement arrived at the Prime Meridian Conference in Washington the following year. Delegates from twenty-six countries voted 22-1 (with San Domingo dissenting) to accept Greenwich as zero longitude and to recommend the railway zones as a basis for global standard time. Astronomers approved; many municipal councils did not. In Dublin, shopkeepers printed dual-time receipts well into the 1900s, while Marseille kept its own meridian until 1911. The Earth had been mathematically unified, but its inhabitants adjusted by slow degrees.`,
            `When London's Natural History Museum began digitising its bird-egg cabinet in 2012, curators expected to confirm dates and Latin names; instead, they uncovered a century-old detective story. Label #4172-a clutch of four chalky-blue eggs-was recorded in 1895 as Turdus migratorius, the American robin, supposedly collected in Manitoba. Yet chemical analysis of their shells, performed during digitisation, revealed strontium-isotope ratios matching soils in northern Norway, not Canada. Puzzled, the team searched expedition diaries for 1895 and found that Frederick Dawson, an amateur oölogist, had indeed travelled to Manitoba that spring. His notes, however, mention trading spare collecting equipment with two Norwegian fishermen encountered on the voyage home. A further clue lay in Dawson's correspondence: a terse 1896 letter to The Oölogists' Monthly defending the "honourable exchange of specimens between gentlemen." The museum now suspects that the robin label masked a rarer prize-eggs of the red-throated thrush, Turdus ruficollis, then highly sought by European collectors but protected by new Scandinavian hunting laws. Dawson, it seems, relabelled the eggs to ease them through British customs.\nThe revelation has modern consequences. Because isotope "fingerprints" can pinpoint natal regions, current conservation scientists use historical shells to map shifts in breeding ranges over time. Mislabelled specimens corrupt those maps. After the Dawson find, the museum audited 3,000 eggs using the same geochemical test; seven percent bore locations inconsistent with their isotopic signatures. Correcting the records has already adjusted models of Arctic warbler migration used by policy-makers planning wind-farm corridors. Ironically, Dawson's deception now enhances, rather than diminishes, scientific value: the tainted label became a tracer, alerting researchers to hidden biases in one of the world's authoritative datasets.`,
            `In 1842, a twelve-year-old could work a ten-hour shift in a Lancashire cotton mill and still be considered a child under English law; yet courts in the same decade tried fourteen-year-olds as adults for burglary. Fast-forward to 1971, when the United States ratified the Twenty-Sixth Amendment, lowering the voting age from twenty-one to eighteen on the grounds that men old enough to be drafted for Vietnam were old enough to choose political leaders. Today, neuroscientists warn that full frontal-lobe maturation-linked to impulse control-may not occur until age twenty-five, while the European Commission debates a proposal to standardise the "digital age of consent" for social-media data at sixteen.\nThe result is a legal mosaic: in France a fifteen-year-old may consent to sex, yet must be eighteen to sign a binding contract; in Japan, criminal responsibility begins at thirteen, but a twenty-year-old still drinks under parental licence. Policymakers justify each threshold differently-economic productivity, military liability, psychological readiness-but rarely reconcile them. Sociologists argue that such patchwork reflects shifting anxieties rather than coherent principle: wartime conscription emphasises bodily maturity, recessions highlight fiscal self-reliance, and data scandals foreground cognitive vulnerability.\nMeanwhile, the global median age at first marriage has climbed from twenty-one in 1970 to nearly thirty today, and lenders in four OECD countries now require parental co-signatures on mortgages taken by applicants under twenty-five. As economic dependence stretches, some scholars suggest that "adulthood" has fragmented into biological, civic, and financial milestones that no longer converge on a single birthday-if they ever truly did.`,
            `For most of the twentieth century, astronomers considered city-centre observatories a tolerable compromise: electric street-lighting washed out only the faintest stars, while the brighter planets remained visible enough for positional measurements. That balance, however, has tilted sharply in the past three decades. Between 1992 and 2020, the global area exposed to artificial night-time brightness above the threshold defined by the International Dark Sky Association expanded by an estimated 270%. Contributing factors include the proliferation of inexpensive LED fixtures, a doubling of motorway length world-wide, and an architectural fashion for glass-clad office blocks that leave interior lights on well past midnight.\nLight pollution does more than hinder astronomy. Field studies on Eptesicus serotinus-one of Europe's larger insect-eating bats-show that females roosting within three kilometres of a major motorway give birth on average six days later than conspecifics in unlit woodland. The delay is thought to arise because high-intensity lamps attract swarms of moths and beetles, tempting bats into extended bouts of nocturnal foraging that shorten daytime rest. Late births push weaning into cooler autumn nights, reducing juvenile survival.\nMunicipalities are not indifferent to these findings, yet economics complicate mitigation. A 2021 audit in northern Italy revealed that dimming LED street-lamps by 30% after 11 p.m. saved the average town barely €2.40 per resident per year-an amount smaller than the administrative cost of retrofitting smart controls. Consequently, most councils prioritise road-safety metrics, for which illuminated junctions score well, over ecological targets that lack statutory weight. Until legislation aligns the two, conservationists argue, voluntary reductions will remain patchy at best.`
        ];
        const questions = [
            { passageIndex: 0, type: 'Inference', text: "Based on the passage, the author would most likely agree that the chief motive behind the creation of standard time was:", options: ["to simplify nautical navigation for naval powers.", "to prevent accidents and confusion on expanding rail networks.", "to satisfy astronomers who required a universal meridian.", "to reinforce British political influence at international conferences."], correctAnswer: "B", explanation: "The passage directly links the adoption of standard time to railways, citing the need to prevent 'missed connections (and lawsuits)' and a 'near-collision outside New Jersey' as key motivators." },
            { passageIndex: 0, type: 'Direct Retrieval', text: "According to the passage, which of the following occurred in 1884?", options: ["The United States railroads secretly drafted a four-zone time map.", "Greenwich was formally adopted as the world's prime meridian.", "British church clocks finally synchronised with railway time.", "Marseille abandoned its local meridian in favour of standard time."], correctAnswer: "B", explanation: "The passage states that the Prime Meridian Conference in Washington occurred in 'the following year' after 1883. At this 1884 conference, delegates voted to 'accept Greenwich as zero longitude'." },
            { passageIndex: 0, type: 'Conclusion', text: "What conclusion can reasonably be drawn about local communities' response to standard time?", options: ["They immediately welcomed the change because it boosted commerce.", "Resistance persisted for decades, indicating that cultural habits outweighed practical advantages for many people.", "Opposition was limited to towns without telegraph connections.", "Most protests were orchestrated by religious authorities rather than civic leaders."], correctAnswer: "B", explanation: "The passage notes that 'many church towers still rang their own, stubborn minutes late' long after railway time was adopted, and that places like Dublin and Marseille kept their local time 'well into the 1900s' and until 1911, respectively. This shows long-term resistance." },
            { passageIndex: 0, type: 'Inference', text: "The passage suggests that cooperation between which pair of professions was essential for the successful spread of standard time?", options: ["Cartographers and lighthouse engineers", "Telegraph operators and railway managers", "Politicians and postal clerks", "Watchmakers and insurance brokers"], correctAnswer: "B", explanation: "'Railway managers' are credited with drafting the time zone map in the US, while 'telegraphers' sent the signals that allowed station-masters to reset clocks across the network, making their collaboration crucial." },
            { passageIndex: 1, type: 'Direct Retrieval', text: "According to the passage, the initial purpose of the 2012 digitisation project was mainly to:", options: ["publicise the rarity of certain egg specimens.", "verify and transcribe the collection's existing catalogue details.", "conduct chemical analysis on all eggs for conservation modelling.", "search for evidence of historical wildlife crimes."], correctAnswer: "B", explanation: "The first sentence clearly states that when the project began, 'curators expected to confirm dates and Latin names,' which is another way of saying they intended to verify and transcribe existing catalogue details." },
            { passageIndex: 1, type: 'Direct Retrieval', text: "Which piece of evidence directly undermined the original Manitoba origin of label #4172?", options: ["Dawson's diary reference to Norwegian fishermen.", "The scarcity of Turdus ruficollis eggs in European cabinets.", "Strontium-isotope ratios in the eggshells that matched Norwegian geology.", "A British customs declaration form from 1895."], correctAnswer: "C", explanation: "The passage explicitly states that 'chemical analysis of their shells... revealed strontium-isotope ratios matching soils in northern Norway, not Canada.' This was the direct, scientific evidence that contradicted the label." },
            { passageIndex: 1, type: 'Inference/Conclusion', text: "What can most plausibly be inferred about the seven percent of eggs whose stated locations conflict with isotope data?", options: ["They likely came from birds whose migratory patterns have changed so dramatically that historical shell chemistry no longer matches modern soil signatures.", "The discrepancies probably arise from a combination of innocent catalogue mistakes and deliberate mislabelling, implying that researchers must treat historical specimen data with systematic scrutiny before drawing ecological conclusions.", "They were almost certainly part of a single, large swap orchestrated by Dawson and therefore share the same Scandinavian provenance as label #4172.", "Because only strontium was analysed, the conflicting signatures are most sensibly attributed to laboratory contamination rather than faults in the original labels."], correctAnswer: "B", explanation: "The passage details one case of deliberate deception (Dawson) and notes the discovery alerted researchers to 'hidden biases' in datasets. This suggests the 7% could include both intentional mislabelling and other errors, supporting the need for systematic scrutiny. The other options are too specific or make unsupported assumptions." },
            { passageIndex: 1, type: 'Conclusion', text: "The author would most likely agree that Dawson's act of relabelling eggs ultimately:", options: ["highlights how unethical practices can unexpectedly contribute to methodological advances.", "proves that Victorian collectors were generally dishonest.", "had no significant impact on modern scientific studies.", "delayed global conservation efforts by several decades."], correctAnswer: "A", explanation: "The passage concludes by stating, 'Ironically, Dawson's deception now enhances, rather than diminishes, scientific value: the tainted label became a tracer, alerting researchers to hidden biases'. This directly supports the idea that an unethical act led to a positive scientific outcome (methodological advancement)." },
            { passageIndex: 2, type: 'Conclusion', text: "Which statement best summarises the author's central claim about modern adulthood?", options: ["Advances in neuroscience have definitively settled the question of when adulthood begins.", "Contemporary societies apply multiple, sometimes conflicting, criteria to define adulthood, revealing more about social priorities than about human development.", "Economic factors now play a minor role compared with biological ones in setting age thresholds.", "Historical age requirements were more coherent because life expectancies were shorter"], correctAnswer: "B", explanation: "The author describes a 'legal mosaic' and a 'patchwork' of thresholds based on 'shifting anxieties rather than coherent principle.' The entire passage argues that the definition of adulthood is inconsistent and reflects societal needs (military, economic, etc.) more than a fixed developmental stage." },
            { passageIndex: 2, type: 'Direct Retrieval', text: "According to the passage, which change most clearly illustrates how geopolitical events can influence legal definitions of adulthood?", options: ["France setting the age of sexual consent at fifteen", "Japan allowing drinking only under parental licence until twenty", "The U.S. lowering the voting age to eighteen during the Vietnam era", "OECD lenders demanding parental co-signatures for under-twenty-five mortgage applicants"], correctAnswer: "C", explanation: "The passage explicitly connects the lowering of the US voting age to the Vietnam War draft: 'men old enough to be drafted for Vietnam were old enough to choose political leaders.' This is a direct link between a geopolitical event and a legal definition of adulthood." },
            { passageIndex: 2, type: 'Inference', text: "What can reasonably be inferred about the proposal to standardise the digital age of consent at sixteen?", options: ["It assumes cognitive maturity for online decisions develops earlier than neuroscientists' estimate of full frontal-lobe maturation.", "It is likely to replace existing national age thresholds for marriage and military service.", "It reflects a primary concern with economic self-reliance rather than privacy.", "It will automatically harmonise criminal-responsibility laws across the European Union."], correctAnswer: "A", explanation: "The passage juxtaposes the proposed age of sixteen with the neuroscientific finding that the frontal lobe (linked to impulse control) may not mature until age twenty-five. Setting the consent age lower implies an assumption that the specific maturity needed for online data consent is reached before full brain maturation." },
            { passageIndex: 2, type: 'Inference', text: "The author would most likely agree that the growing separation between biological, civic and financial milestones:", options: ["renders any single legal definition of adulthood inherently provisional.", "proves that historical societies misunderstood adolescent psychology.", "demonstrates the success of modern education systems in prolonging youth.", "will cease once housing markets become more affordable."], correctAnswer: "A", explanation: "The passage concludes by suggesting adulthood has 'fragmented into biological, civic, and financial milestones that no longer converge on a single birthday.' This fragmentation and the use of conflicting criteria imply that any single, fixed definition is temporary and subject to societal shifts, making it 'inherently provisional'." },
            { passageIndex: 3, type: 'True/False/CantTell', text: "The proportion of Earth's surface affected by disruptive night-time brightness has almost quadrupled since the early 1990s.", options: ["True", "False", "Can't Tell"], correctAnswer: "A", explanation: "The passage states the area expanded by 'an estimated 270%.' An increase of 270% on the original 100% results in a total of 370% of the original area (100% + 270%). This is 3.7 times the original size, which is 'almost quadrupled'." },
            { passageIndex: 3, type: 'True/False/CantTell', text: "Female Eptesicus serotinus near brightly lit motorways spend less time feeding than those in darker habitats.", options: ["True", "False", "Can't Tell"], correctAnswer: "B", explanation: "The passage states that the bats are tempted into 'extended bouts of nocturnal foraging.' This means they spend more time feeding, not less. The negative consequence is shortened daytime rest, which delays births." },
            { passageIndex: 3, type: 'Direct Retrieval', text: "According to the passage, why are municipalities in northern Italy hesitant to dim streetlights despite the ecological benefits?", options: ["They are unaware of the negative impacts on local bat populations.", "The cost of retrofitting smart controls outweighs the annual financial savings from dimming.", "Local residents have protested against dimmer streets, citing safety concerns.", "LED fixtures are incompatible with dimming technology."], correctAnswer: "B", explanation: "The passage explicitly states that the annual saving of 'barely €2.40 per resident per year' was 'an amount smaller than the administrative cost of retrofitting smart controls.' This direct economic comparison is the reason for their hesitation." },
            { passageIndex: 3, type: 'Conclusion', text: "What solution do conservationists propose to address the issue of light pollution effectively?", options: ["A global ban on the installation of new LED street-lighting.", "Launching public awareness campaigns to encourage voluntary reductions in light use.", "Developing cheaper smart control technology for street-lamps.", "Creating legislation that gives ecological targets similar importance to road-safety metrics."], correctAnswer: "D", explanation: "The passage's final sentence reflects the conservationists' view: 'Until legislation aligns the two [road-safety metrics and ecological targets], conservationists argue, voluntary reductions will remain patchy at best.' This implies their proposed solution is legislative alignment." }
        ];

        let currentQuestionIndex = 0;
        let userAnswers = new Array(questions.length).fill(null);
        let timerInterval;
        let timeLeft = 9 * 60;
        let examStartTime;
        let examEndTime;
        let userName = '';
        let userGoal = '';
        let userFocusArea = '';
        let isReviewingFromResults = false;
        let questionStartTime = null;
        let questionTimes = new Array(questions.length).fill(0);
        let flaggedQuestions = new Array(questions.length).fill(false);
        let isFilteringFlagged = false;
        let currentlyDisplayedPassageIndex = -1;
        let currentFontSize = 1.0;

        // --- Elements & Functions ---
        const appContainer = document.getElementById('app-container');
        const setupScreen = document.getElementById('setup-screen');
        const examScreen = document.getElementById('exam-screen');
        const reviewScreen = document.getElementById('review-screen');
        const resultsScreen = document.getElementById('results-screen');
        const navigatorModal = document.getElementById('navigator-modal');
        const startButton = document.getElementById('start-button');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const navigatorButton = document.getElementById('navigator-button');
        const closeModalButton = document.getElementById('close-modal-button');
        const endExamButton = document.getElementById('end-exam-button');
        const endExamButtonFooter = document.getElementById('end-exam-button-footer');
        const backToResultsButton = document.getElementById('back-to-results-button');
        const flagButton = document.getElementById('flag-button');
        const passageNumberEl = document.getElementById('passage-number');
        const passageTextEl = document.getElementById('passage-text');
        const questionNumberEl = document.getElementById('question-number');
        const questionNumberInfoEl = document.getElementById('question-number-info');
        const questionTextEl = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const timerEl = document.getElementById('timer');
        const reviewGrid = document.getElementById('review-grid');
        const navigatorGrid = document.getElementById('navigator-grid');
        const scoreEl = document.getElementById('score');
        const totalQuestionsResultsEl = document.getElementById('total-questions-results');
        const timeTakenEl = document.getElementById('time-taken');
        const resultsGridContainer = document.getElementById('results-grid-container');
        const nameInput = document.getElementById('name');
        const goalInput = document.getElementById('goal');
        const focusAreaInput = document.getElementById('focus-area');
        const examTitleEl = document.getElementById('exam-title');
        const filterFlaggedButton = document.getElementById('filter-flagged-button');
        const setupQuestionCountEl = document.getElementById('setup-question-count');
        const setupTimeLimitEl = document.getElementById('setup-time-limit');
        const reviewExplanationContainer = document.getElementById('review-explanation-container');
        const downloadPdfButton = document.getElementById('download-pdf-button');
        const fontDecreaseButton = document.getElementById('font-decrease-button');
        const fontIncreaseButton = document.getElementById('font-increase-button');
        const resizableTextElements = document.querySelectorAll('.resizable-text');
        const timeAnalysisResultsEl = document.getElementById('time-analysis-results');
        const typeAnalysisResultsEl = document.getElementById('type-analysis-results');

        function startTimer() { examStartTime = new Date(); clearInterval(timerInterval); timerEl.textContent = formatTimeSeconds(timeLeft); timerInterval = setInterval(() => { timeLeft--; timerEl.textContent = formatTimeSeconds(timeLeft); if (timeLeft <= 0) { endExamAndShowResults(); } }, 1000); }
        function stopTimer() { clearInterval(timerInterval); examEndTime = examEndTime || new Date(); }
        function formatTimeSeconds(totalSeconds) { if (totalSeconds < 0) totalSeconds = 0; const minutes = Math.floor(totalSeconds / 60); const seconds = totalSeconds % 60; return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`; }
        function formatTimeMilliseconds(milliseconds) { if (!milliseconds || milliseconds < 0) return "0s"; return `${(milliseconds / 1000).toFixed(1)}s`; }
        function formatTimeDifference(milliseconds) { if (!milliseconds || milliseconds < 0) return "0 min 00 sec"; const totalSeconds = Math.round(milliseconds / 1000); const minutes = Math.floor(totalSeconds / 60); const seconds = totalSeconds % 60; return `${minutes} min ${seconds < 10 ? '0' : ''}${seconds} sec`; }
        function recordTimeSpent(index) { if (questionStartTime && index >= 0 && index < questions.length) { questionTimes[index] = (questionTimes[index] || 0) + (Date.now() - questionStartTime); } questionStartTime = null; }
        function toggleFlag() { if (isReviewingFromResults) return; flaggedQuestions[currentQuestionIndex] = !flaggedQuestions[currentQuestionIndex]; updateFlagButtonAppearance(); updateNavigatorButtons(); }
        function updateFlagButtonAppearance() { const isFlagged = flaggedQuestions[currentQuestionIndex]; flagButton.textContent = isFlagged ? 'Unflag' : 'Flag for Review'; flagButton.classList.toggle('flagged', isFlagged); }
        function updateFontSize() { resizableTextElements.forEach(el => { el.querySelectorAll('#passage-text, #question-text, .option-label').forEach(child => { child.style.fontSize = `${currentFontSize}rem`; }); }); }
        function loadQuestion(index, reviewMode = false) { if (index < 0 || index >= questions.length) return; if (!isReviewingFromResults && !reviewMode) { recordTimeSpent(currentQuestionIndex); } const question = questions[index]; const newPassageIndex = question.passageIndex; if (newPassageIndex !== currentlyDisplayedPassageIndex || reviewMode) { passageTextEl.innerHTML = passages[newPassageIndex].replace(/\n/g, '<br><br>'); passageNumberEl.textContent = newPassageIndex + 1; currentlyDisplayedPassageIndex = newPassageIndex; document.querySelector('.passage-column').scrollTop = 0; } currentQuestionIndex = index; isReviewingFromResults = reviewMode; questionNumberEl.textContent = index + 1; questionNumberInfoEl.textContent = `${index + 1} of ${questions.length}`; questionTextEl.textContent = question.text; document.querySelector('.question-column').scrollTop = 0; optionsContainer.innerHTML = ''; reviewExplanationContainer.innerHTML = ''; const optionLetters = question.options.length === 3 ? ['A', 'B', 'C'] : ['A', 'B', 'C', 'D']; question.options.forEach((option, i) => { const optionId = `q${index}_opt${i}`; const label = document.createElement('label'); label.htmlFor = optionId; label.className = 'option-label'; label.dataset.optionIndex = i; const radio = document.createElement('input'); radio.type = 'radio'; radio.id = optionId; radio.name = `question_${index}`; radio.value = optionLetters[i]; radio.disabled = reviewMode; label.style.cursor = reviewMode ? 'default' : 'pointer'; if (userAnswers[index] === optionLetters[i]) { radio.checked = true; label.classList.add('selected-answer'); } if (reviewMode) { const isCorrectAnswer = question.correctAnswer === optionLetters[i]; const isSelectedAnswer = userAnswers[index] === optionLetters[i]; if (isCorrectAnswer) { label.classList.add('border-green-500', 'border-2', 'bg-green-50'); } else if (isSelectedAnswer) { label.classList.add('border-red-500', 'border-2', 'bg-red-50'); } } label.appendChild(radio); label.appendChild(document.createTextNode(question.type === 'True/False/CantTell' ? ` ${option}` : ` ${optionLetters[i]}) ${option}`)); if (!reviewMode) { label.addEventListener('click', () => handleOptionSelect(index, i, optionLetters[i])); radio.addEventListener('change', () => handleOptionSelect(index, i, optionLetters[i])); } optionsContainer.appendChild(label); }); if (reviewMode && question.explanation) { const explanationDiv = document.createElement('div'); explanationDiv.className = 'explanation-box'; explanationDiv.innerHTML = `<strong class="font-semibold">Explanation:</strong><br>${question.explanation.replace(/\n/g, '<br>')}`; reviewExplanationContainer.appendChild(explanationDiv); } prevButton.disabled = index === 0; nextButton.textContent = (!reviewMode && index === questions.length - 1) ? 'Finish & Review' : 'Next (Alt+N) →'; if(reviewMode) nextButton.disabled = index === questions.length - 1; updateFlagButtonAppearance(); backToResultsButton.classList.toggle('hidden', !reviewMode); endExamButtonFooter.classList.toggle('hidden', reviewMode); examTitleEl.textContent = reviewMode ? "Reviewing Question" : "Verbal Reasoning"; flagButton.disabled = reviewMode; updateNavigatorHighlight(); updateFontSize(); if (!isReviewingFromResults) { questionStartTime = Date.now(); } }
        function handleOptionSelect(questionIndex, optionIndex, optionValue) { if (questionIndex !== currentQuestionIndex || isReviewingFromResults) return; userAnswers[questionIndex] = optionValue; document.querySelectorAll(`#options-container .option-label`).forEach(lbl => lbl.classList.remove('selected-answer')); const selectedLabel = document.querySelector(`#options-container label[for="q${questionIndex}_opt${optionIndex}"]`); if (selectedLabel) { selectedLabel.classList.add('selected-answer'); selectedLabel.querySelector('input[type="radio"]').checked = true; } updateNavigatorButtons(); }
        function showNextQuestion() { const reviewMode = isReviewingFromResults; const nextIndex = currentQuestionIndex + 1; if (nextIndex < questions.length) { loadQuestion(nextIndex, reviewMode); } else if (!reviewMode) { recordTimeSpent(currentQuestionIndex); stopTimer(); showReviewScreen(); } }
        function showPrevQuestion() { if (currentQuestionIndex > 0) { loadQuestion(currentQuestionIndex - 1, isReviewingFromResults); } }
        function showScreen(screenToShow) { [setupScreen, examScreen, reviewScreen, resultsScreen].forEach(screen => { screen.classList.add('hidden'); screen.classList.remove('flex'); }); screenToShow.classList.remove('hidden'); if (screenToShow !== examScreen) appContainer.classList.remove('!border-none', '!shadow-none', '!m-0', '!rounded-none'); else appContainer.classList.add('!border-none', '!shadow-none', '!m-0', '!rounded-none'); if (screenToShow === setupScreen || screenToShow === resultsScreen) { screenToShow.classList.add('flex'); } }
        function showReviewScreen(filterFlagged = false) { recordTimeSpent(currentQuestionIndex); stopTimer(); showScreen(reviewScreen); reviewScreen.classList.add('flex'); reviewGrid.innerHTML = ''; questions.forEach((_, index) => { if (filterFlagged && !flaggedQuestions[index]) return; const button = document.createElement('button'); button.textContent = index + 1; button.className = 'review-grid-button'; button.classList.toggle('review-grid-button-answered', userAnswers[index] !== null); button.classList.toggle('review-grid-button-unanswered', userAnswers[index] === null); if (flaggedQuestions[index]) button.classList.add('review-flagged'); button.onclick = () => { showScreen(examScreen); examScreen.classList.add('flex'); loadQuestion(index); startTimer(); }; reviewGrid.appendChild(button); }); filterFlaggedButton.textContent = filterFlagged ? 'Show All Questions' : 'Show Flagged Only'; }
        function populateNavigator() { navigatorGrid.innerHTML = ''; questions.forEach((_, index) => { const button = document.createElement('button'); button.textContent = index + 1; button.className = 'py-2 px-1 border border-gray-300 rounded-md text-center transition duration-150 ease-in-out text-sm hover:bg-gray-100'; button.dataset.questionIndex = index; if (userAnswers[index]) button.classList.add('nav-answered'); if (index === currentQuestionIndex) button.classList.add('nav-current'); if (flaggedQuestions[index]) button.classList.add('nav-flagged'); button.onclick = () => { navigatorModal.classList.remove('flex'); loadQuestion(parseInt(button.dataset.questionIndex, 10), isReviewingFromResults); if (!isReviewingFromResults) questionStartTime = Date.now(); }; navigatorGrid.appendChild(button); }); }
        function updateNavigatorButtons() { navigatorGrid.querySelectorAll('button').forEach(button => { const index = parseInt(button.dataset.questionIndex, 10); button.classList.toggle('nav-answered', !!userAnswers[index]); button.classList.toggle('nav-current', index === currentQuestionIndex); button.classList.toggle('nav-flagged', flaggedQuestions[index]); }); }
        function updateNavigatorHighlight() { navigatorGrid.querySelectorAll('button').forEach(button => { button.classList.toggle('nav-current', parseInt(button.dataset.questionIndex, 10) === currentQuestionIndex); }); }
        function analyzeAndDisplayPerformance() { let correctTimeTotal = 0, correctCount = 0, incorrectTimeTotal = 0, incorrectCount = 0; const typeStats = {}; questions.forEach((q, i) => { const isCorrect = userAnswers[i] === q.correctAnswer; if (userAnswers[i] !== null) { (isCorrect ? (correctTimeTotal += questionTimes[i], correctCount++) : (incorrectTimeTotal += questionTimes[i], incorrectCount++)); } const qType = q.type || 'Uncategorized'; if (!typeStats[qType]) typeStats[qType] = { correct: 0, total: 0 }; typeStats[qType].total++; if(isCorrect) typeStats[qType].correct++; }); timeAnalysisResultsEl.innerHTML = `<p class="flex justify-between"><span>Avg. time (Correct):</span> <span class="font-bold text-green-600">${correctCount > 0 ? formatTimeMilliseconds(correctTimeTotal / correctCount) : 'N/A'}</span></p><p class="flex justify-between"><span>Avg. time (Incorrect):</span> <span class="font-bold text-red-600">${incorrectCount > 0 ? formatTimeMilliseconds(incorrectTimeTotal / incorrectCount) : 'N/A'}</span></p>`; typeAnalysisResultsEl.innerHTML = ''; Object.keys(typeStats).sort().forEach(type => { const stats = typeStats[type]; const percentage = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0; typeAnalysisResultsEl.innerHTML += `<p class="flex justify-between"><span>${type}:</span> <span class="font-bold">${stats.correct}/${stats.total} (${percentage}%)</span></p>`; }); }
        function showResultsScreen() { examEndTime = examEndTime || new Date(); recordTimeSpent(currentQuestionIndex); stopTimer(); showScreen(resultsScreen); let score = 0; resultsGridContainer.innerHTML = ''; questions.forEach((qData, index) => { const isCorrect = userAnswers[index] === qData.correctAnswer; if (isCorrect) score++; const container = document.createElement('div'); const resultBox = document.createElement('div'); resultBox.className = 'result-box'; resultBox.classList.add(isCorrect ? 'result-box-correct' : 'result-box-incorrect'); if (flaggedQuestions[index]) resultBox.classList.add('result-box-flagged'); resultBox.title = `Click to review Question ${index + 1}`; const timeDiv = document.createElement('div'); timeDiv.className = 'time-spent'; timeDiv.textContent = `${Math.round((questionTimes[index] || 0) / 1000)}s`; resultBox.appendChild(timeDiv); container.appendChild(resultBox); const qNumDiv = document.createElement('div'); qNumDiv.className = 'question-num-label'; qNumDiv.textContent = `Q${index + 1}`; container.appendChild(qNumDiv); container.addEventListener('click', () => revisitQuestionFromResults(index)); resultsGridContainer.appendChild(container); }); scoreEl.textContent = score; totalQuestionsResultsEl.textContent = questions.length; timeTakenEl.textContent = formatTimeDifference(examEndTime - examStartTime); analyzeAndDisplayPerformance(); }
        function revisitQuestionFromResults(index) { showScreen(examScreen); examScreen.classList.add('flex'); loadQuestion(index, true); }
        function endExamAndShowResults() { stopTimer(); showResultsScreen(); }
        function generatePDF() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); let y = 15; const lineHeight = 7; const margin = 15; const pageWidth = doc.internal.pageSize.width; doc.setFontSize(18); doc.text("UCAT Verbal Reasoning Results", pageWidth / 2, y, { align: 'center' }); y += lineHeight * 2; doc.setFontSize(12); const summaryData = [ ["Name:", userName || 'N/A'], ["Goal:", `${userGoal || 'N/A'} / ${questions.length}`], ["Focus Area:", userFocusArea || 'N/A'], ["Final Score:", `${scoreEl.textContent} / ${questions.length}`], ["Time Taken:", timeTakenEl.textContent] ]; summaryData.forEach(row => { doc.setFont(undefined, 'bold'); doc.text(row[0], margin, y); doc.setFont(undefined, 'normal'); doc.text(row[1], margin + 40, y); y += lineHeight; }); y += lineHeight; doc.save(`ucat_vr_results_${userName.replace(/\s+/g, '_') || 'user'}.pdf`); }
        
        // --- Event Listeners ---
        startButton.addEventListener('click', () => { userName = nameInput.value.trim(); userGoal = goalInput.value.trim(); userFocusArea = focusAreaInput.value.trim(); timeLeft = 9 * 60; showScreen(examScreen); examScreen.classList.add('flex'); startTimer(); loadQuestion(0); populateNavigator(); });
        nextButton.addEventListener('click', showNextQuestion);
        prevButton.addEventListener('click', showPrevQuestion);
        endExamButton.addEventListener('click', endExamAndShowResults);
        endExamButtonFooter.addEventListener('click', () => { recordTimeSpent(currentQuestionIndex); stopTimer(); showReviewScreen(); });
        backToResultsButton.addEventListener('click', () => { isReviewingFromResults = false; showResultsScreen(); });
        navigatorButton.addEventListener('click', () => { recordTimeSpent(currentQuestionIndex); updateNavigatorButtons(); navigatorModal.classList.add('flex'); });
        closeModalButton.addEventListener('click', () => { navigatorModal.classList.remove('flex'); if (!isReviewingFromResults) questionStartTime = Date.now(); });
        navigatorModal.addEventListener('click', (event) => { if (event.target === navigatorModal) closeModalButton.click(); });
        flagButton.addEventListener('click', toggleFlag);
        filterFlaggedButton.addEventListener('click', () => { isFilteringFlagged = !isFilteringFlagged; showReviewScreen(isFilteringFlagged); });
        downloadPdfButton.addEventListener('click', generatePDF);
        fontIncreaseButton.addEventListener('click', () => { if(currentFontSize < 1.5) { currentFontSize += 0.1; updateFontSize(); } });
        fontDecreaseButton.addEventListener('click', () => { if (currentFontSize > 0.8) { currentFontSize -= 0.1; updateFontSize(); } });

        document.addEventListener('keydown', (e) => {
             const isExamVisible = !examScreen.classList.contains('hidden');
             const isModalVisible = navigatorModal.classList.contains('flex');
             const isInputFocused = document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA');
             if (isModalVisible || isInputFocused || !isExamVisible) return;
             if (e.altKey) {
                 if (e.code.toLowerCase() === 'keyn') { e.preventDefault(); if (!nextButton.disabled) nextButton.click(); }
                 if (e.code.toLowerCase() === 'keyp') { e.preventDefault(); if (!prevButton.disabled) prevButton.click(); }
                 if (e.code.toLowerCase() === 'keyf') { e.preventDefault(); if (!isReviewingFromResults && !flagButton.disabled) flagButton.click(); }
             } else if (['a', 'b', 'c', 'd'].includes(e.key.toLowerCase()) && !isReviewingFromResults) {
                 e.preventDefault();
                 const optionIndex = ['a', 'b', 'c', 'd'].indexOf(e.key.toLowerCase());
                 if (optionIndex < questions[currentQuestionIndex].options.length) {
                     handleOptionSelect(currentQuestionIndex, optionIndex, ['A', 'B', 'C', 'D'][optionIndex]);
                 }
             }
        });

        // --- Initial Load ---
        showScreen(setupScreen);
        updateFontSize();

    </script>
</body>
</html>
